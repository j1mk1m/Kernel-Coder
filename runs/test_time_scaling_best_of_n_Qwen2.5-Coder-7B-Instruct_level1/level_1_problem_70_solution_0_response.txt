Please note that you should be able to compile and run the provided code. The code should produce correct results, and it should be optimized using custom CUDA kernels where appropriate. Make sure to provide detailed explanations for any custom CUDA kernels you create, including the reasoning behind their design choices.