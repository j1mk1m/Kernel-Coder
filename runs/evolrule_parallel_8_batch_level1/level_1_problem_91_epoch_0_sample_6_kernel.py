This should be the final optimized code.