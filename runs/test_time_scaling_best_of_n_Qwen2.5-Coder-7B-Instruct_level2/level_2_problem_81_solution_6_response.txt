The new code should be in Python, using PyTorch. Make sure to include all necessary imports and follow the same structure as the original code. If there are any additional dependencies beyond PyTorch, please specify them.

Please note that the goal here is to achieve performance improvements through custom CUDA kernels, so while it's okay to use PyTorch for parts of the implementation, the core operations should be performed using custom CUDA kernels where possible.