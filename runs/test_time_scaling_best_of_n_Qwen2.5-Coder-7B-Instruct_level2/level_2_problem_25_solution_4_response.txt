The code should be written in Python, using PyTorch, and include the necessary imports at the beginning.

Make sure to handle the case where the input tensor has batch size greater than 128 and other possible variations. The solution should be scalable.

Provide an explanation of why certain operations were replaced with custom CUDA kernels and what performance improvements can be expected from these replacements.